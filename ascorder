from django.shortcuts import render,redirect
import subprocess
from datetime import date
import ast
import datetime
import os
from django.http import HttpResponse


def curl_view(request):
    new_result=""
    arg1=""
    arg2=""
    curl_command=""
    now=datetime.datetime.now().strftime('%d-%m-%Y')
    cache_now=datetime.datetime.now().strftime('%d-%m-%Y')
    field_list=[]
    command=f"su - eisuser -c ' ssh -tq 10.191.171.80 \" python /home/scripts/CONFIG/field_list.py \" '"
    result=subprocess.run(command,capture_output=True,shell=True,text=True)
    new_res=result.stdout.strip()
    field_list=ast.literal_eval(new_res)
    cache_count=len(field_list)
    if request.method == "POST":
        if request.POST.get("action") == "search":
            arg1 = request.POST.get('arg1','').strip()
            arg2 = request.POST.get('arg2','').strip()
            script_path=f"/home/scripts/CONFIG/curl_search.py"
            command=f'python {script_path} "{arg1}" "{arg2}"'
            result=subprocess.run(command,capture_output=True,shell=True,text=True)
            resout=result.stdout.strip()
            reserr=result.stderr.strip()
            get_result=resout or reserr
            if arg2 not in field_list:
                get_result="No such Field."
            x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
            if x_forwarded_for:
                curl_command = x_forwarded_for.split(',')[0]
            else:
                curl_command = request.META.get('REMOTE_ADDR')
            curl= f'curl -k -X GET http://{arg1}:8002/cache/v1/loadCache?"FIELD_NAME"="{arg2}"'
            full_time=datetime.datetime.now().strftime('%c')
            now=datetime.datetime.now().strftime('%d-%m-%Y')
            files_dir=f'/var/www/cgi-bin/PyPortal/curl_search/curl_logs/'
            os.makedirs(files_dir, exist_ok=True)
            os.chmod(files_dir,0o777)
            files_path=f"{files_dir}logs_{now}"
            fw=open(files_path,'a')
            fw.write(curl_command+","+full_time+","+curl+","+get_result+"\n")
            fw.close()

            request.session['get_result']=get_result
            return redirect('curl_search')

        elif request.POST.get("post_value") == "POST":
            arg3 = request.POST.get('arg3','').strip()
            script_path=f"/home/scripts/CONFIG/curl_post.py"
            command=f'python {script_path} "{arg3}" '
            result=subprocess.run(command,capture_output=True,shell=True,text=True)
            resout=result.stdout.strip()
            reserr=result.stderr.strip()
            post_result=resout or reserr
            x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
            if x_forwarded_for:
                curl_command = x_forwarded_for.split(',')[0]
            else:
                curl_command = request.META.get('REMOTE_ADDR')
            curl=f"curl -k -X POST '{arg3}'"
            full_time=datetime.datetime.now().strftime('%c')
            now=datetime.datetime.now().strftime('%d-%m-%Y')
            files_dir=f'/var/www/cgi-bin/PyPortal/curl_search/curl_logs/'
            os.makedirs(files_dir, exist_ok=True)
            os.chmod(files_dir,0o777)
            files_path=f"{files_dir}logs_{now}"
            fw=open(files_path,'a')
            fw.write(curl_command+","+full_time+","+curl+","+post_result+"\n")
            fw.close()

            request.session['post_result']=post_result
            return redirect('curl_search')
    new_get_result=request.session.pop("get_result",None)
    new_result=request.session.pop("post_result",None)
    return render(request,'curl_search/curl_search.html',{"new_result":new_result,"new_get_result":new_get_result, "curl_command":curl_command , "field_list":field_list,"cache_count":cache_count,"arg1":arg1,"arg2":arg2,"now":now,"cache_now":cache_now})


def curl_logs(request,pk):
    files_dir=f'/var/www/cgi-bin/PyPortal/curl_search/curl_logs/'
    files_path=f"{files_dir}logs_{pk}"
    log_entries=[]
    if os.path.exists(files_path):
        fw=open(files_path,'r')
        for line in fw:
            log_dict=[]
            new_line=line.strip().split(",")
            log_entries.append(new_line)
        log_entries=sorted(log_entries,reverse=True)
    else:
        log_entries=[]

    days_list=[]
    now_date=datetime.datetime.now().strftime('%d_%m_%y')
    for i in range(5):
        day=datetime.datetime.now() - datetime.timedelta(days=i)
        new_day=day.strftime('%d-%m-%Y')
        days_list.append(new_day)


    return render(request, 'curl_search/curl_logs.html',{"logs":log_entries,"selected_date":pk,"days_list":days_list})

def test(request,pk):
    path=f"/home/scripts/CONFIG/cache_field.py"
    command=f" su - eisuser -c ' ssh -tq 10.191.171.80 \" python {path} {pk} \" '  "
    result=subprocess.run(command,capture_output=True,shell=True,text=True)
    new_result=result.stdout.strip()
    new_dict={}
    updated_list=[]
    for line in new_result.splitlines():
        if "extra" in line:
            new_line=line.split("=")
            new_dict=new_line[1].strip()
            new_dict = ast.literal_eval(new_dict)
        if "update" in line:
            new_line=line.split("=")
            update_dict=new_line[1].strip()
            updated_dict=ast.literal_eval(update_dict)
    days_list=[]
    for i in range(5):
        day=datetime.datetime.now() - datetime.timedelta(days=i)
        new_day=day.strftime('%d-%m-%Y')
        days_list.append(new_day)

    return render(request, 'curl_search/updates.html', {"new_dict":new_dict,"updated_dict":updated_dict,"days_list":days_list,"selected_date":pk})
















document.addEventListener("DOMContentLoaded",async ()=> {
var uid=localStorage.getItem('uidd');
var sessionId=localStorage.getItem('sessionid');
  try{
     const response  = await fetch('https://10.191.171.12:5443/EISHOME/awthenticationService/authenticatePortal/',{
     method:'POST',
     headers:{
             'Content-Type':'application/json',
             'Authorization': `Bearer ${sessionId}`

    },
    body: JSON.stringify({uid})
    });
    const data = await response.json();
    if(data.status==302){
            console.log("login successfull");
    }
    else{
            console.log(data.status)
          window.location.href='https://10.191.171.12:5443/EISHOME/';
    }
  }
catch(e){
console.log("an error occured for login"+e)

}
});
