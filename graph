from django.views.decorators.csrf import csrf_exempt
from django.http import JsonResponse
import json

@csrf_exempt
def postFavourites(request):
    try:
        if request.method == 'POST':
            data_json = json.loads(request.body.decode('utf-8'))
            favourites = data_json.get("favList")  # This should be a list
            uid = data_json.get("userId")
            password = data_json.get("password")

            try:
                decryptedPassword = decryptor(password)
            except Exception as e:
                return JsonResponse({"message": "user unauthorized"}, status=401, safe=False)

            if uid and password:
                try:
                    user = Usermaster.objects.get(uid=uid, pwd=decryptedPassword)
                except Exception as e:
                    return JsonResponse({"403 Bad Request": str(e)}, status=403, safe=False)

                # Save favorites if provided
                if favourites is not None:
                    if not isinstance(favourites, list):
                        return JsonResponse({"error": "favList must be an array"}, status=400)

                    fav_str = ",".join(favourites)  # Convert list to string

                    fav_obj, created = UserFavourites.objects.get_or_create(user=user)
                    fav_obj.favouriteOptions = fav_str
                    fav_obj.save()

                    return JsonResponse({"favourites": favourites})  # üîÅ return as list

                # Just fetch favorites
                if UserFavourites.objects.filter(user=user).exists():
                    fav_obj = UserFavourites.objects.get(user=user)
                    fav_str = fav_obj.favouriteOptions or ""
                    fav_list = [item.strip() for item in fav_str.split(',') if item.strip()]
                    return JsonResponse({"favourites": fav_list})  # ‚úÖ return as array

                # If no UserFavourites exists
                UserFavourites.objects.create(favouriteOptions="", user=user)
                return JsonResponse({"favourites": []})

        return JsonResponse({"message": "Only POST supported"}, status=405)

    except Exception as e:
        return JsonResponse({"error": str(e)}, status=500)
