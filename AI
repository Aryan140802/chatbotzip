#!/usr/bin/python3
import os
import json
import socket
import subprocess
import datetime
import requests
from requests.auth import HTTPBasicAuth

# =========================
# TEMP TESTING CREDENTIALS
# =========================
ACE_USERNAME = "PUT_USERNAME_HERE"
ACE_PASSWORD = "PUT_PASSWORD_HERE"

# =========================
# SERVER CONFIG
# =========================
ENVIRONMENT = "PR"
SERVER_ID = "24"
ACE_HOST = "10.188.25.10"
ACE_PORT = 4414

TRUSTSTORE_PATH = "/opt/IBM/Broker_Properties/JKS/TRUSTSTORE.jks"
KEYSTORE_PATH = "/opt/IBM/Broker_Properties/JKS/KEYSTORE.jks"
ENDPOINT_PUBLIC_PATH = "/opt/IBM/EndPoint_Public"

OUTPUT_DIR = "/sync"

# =========================
# UTILS
# =========================
def run(cmd):
    return subprocess.check_output(cmd, stderr=subprocess.DEVNULL, text=True)

def now():
    return datetime.datetime.utcnow().isoformat()

# =========================
# CERTIFICATE COLLECTION
# =========================
def read_jks(path):
    data = {}
    if not os.path.exists(path):
        return data

    out = run(["keytool", "-list", "-v", "-keystore", path, "-storepass", "password"])
    alias = None

    for line in out.splitlines():
        if line.startswith("Alias name:"):
            alias = line.split(":")[1].strip()
            data[alias] = {}
        elif "Valid from" in line and alias:
            parts = line.split("until:")
            data[alias]["valid_from"] = parts[0].split("from")[1].strip()
            data[alias]["valid_to"] = parts[1].strip()
        elif "SHA1:" in line and alias:
            data[alias]["sha1"] = line.split("SHA1:")[1].strip()

    return data

def read_endpoint_certs():
    data = {}
    if not os.path.isdir(ENDPOINT_PUBLIC_PATH):
        return data

    for f in os.listdir(ENDPOINT_PUBLIC_PATH):
        full = os.path.join(ENDPOINT_PUBLIC_PATH, f)
        if not os.path.isfile(full):
            continue

        out = run(["openssl", "x509", "-in", full, "-noout",
                   "-startdate", "-enddate", "-fingerprint"])
        entry = {}
        for line in out.splitlines():
            if line.startswith("notBefore="):
                entry["valid_from"] = line.split("=")[1]
            elif line.startswith("notAfter="):
                entry["valid_to"] = line.split("=")[1]
            elif "SHA1" in line:
                entry["sha1"] = line.split("=")[1]
        data[f] = entry

    return data

# =========================
# ACE DATA
# =========================
def get_ace_data():
    url = f"https://{ACE_HOST}:{ACE_PORT}/apiv2/servers"
    session = requests.Session()
    session.auth = HTTPBasicAuth(ACE_USERNAME, ACE_PASSWORD)
    session.verify = False
    session.headers = {"Accept": "application/json"}

    try:
        r = session.get(url, timeout=20)
        r.raise_for_status()
        return r.json()
    except Exception as e:
        return {"error": str(e)}

# =========================
# MQ DATA (LIGHTWEIGHT)
# =========================
def get_mq_data():
    qms = {}
    try:
        out = run(["dspmq"])
        for line in out.splitlines():
            if "QMNAME" in line:
                qm = line.split("(")[1].split(")")[0]
                qms[qm] = {"channels": [], "listeners": []}

                try:
                    ch = run(["runmqsc", qm], input="DISPLAY CHANNEL(*)\nEND\n")
                    qms[qm]["channels"] = [l for l in ch.splitlines() if "CHANNEL(" in l]
                except:
                    pass

                try:
                    ls = run(["runmqsc", qm], input="DISPLAY LISTENER(*)\nEND\n")
                    qms[qm]["listeners"] = [l for l in ls.splitlines() if "LISTENER(" in l]
                except:
                    pass
    except:
        pass

    return qms

# =========================
# MAIN
# =========================
def main():
    snapshot = {
        "environment": ENVIRONMENT,
        "server_id": SERVER_ID,
        "hostname": socket.gethostname(),
        "generated_at": now(),
        "certificates": {
            "truststore": read_jks(TRUSTSTORE_PATH),
            "keystore": read_jks(KEYSTORE_PATH),
            "endpoint_public": read_endpoint_certs()
        },
        "ace": get_ace_data(),
        "mq": get_mq_data()
    }

    os.makedirs(OUTPUT_DIR, exist_ok=True)
    outfile = f"{OUTPUT_DIR}/server_snapshot_{ENVIRONMENT}_{SERVER_ID}.json"

    with open(outfile, "w") as f:
        json.dump(snapshot, f, indent=2)

    print("Generated:", outfile)

if __name__ == "__main__":
    main()
