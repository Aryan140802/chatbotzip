#!/usr/bin/env python3

import os
import json
import socket
import subprocess
import platform
from datetime import datetime

# ================== CONFIG ==================

OUTPUT_DIR = "./sync"
ENDPOINT_PUBLIC_PATH = "/opt/IBM/EndPoint_Public"

# TEMP testing credentials (REMOVE LATER)
ACE_USER = "v1019468"
ACE_PASS = "Eisking@1234567"

# ============================================


def run(cmd):
    return subprocess.check_output(cmd, stderr=subprocess.DEVNULL, text=True)


# ---------- SYSTEM INFO ----------

def get_system_info():
    return {
        "hostname": socket.gethostname(),
        "ip": socket.gethostbyname(socket.gethostname()),
        "os": platform.platform(),
        "uptime": run(["uptime"]).strip(),
    }


# ---------- CERTIFICATE READING ----------

def parse_openssl_output(out):
    data = {}
    for line in out.splitlines():
        if line.startswith("notBefore="):
            data["valid_from"] = line.split("=")[1]
        elif line.startswith("notAfter="):
            data["valid_to"] = line.split("=")[1]
        elif "SHA1 Fingerprint" in line:
            data["sha1"] = line.split("=")[1]
    return data


def parse_keytool_output(out):
    certs = {}
    alias = None

    for line in out.splitlines():
        if line.startswith("Alias name:"):
            alias = line.split(":")[1].strip()
            certs[alias] = {}
        elif "Valid from" in line and alias:
            parts = line.split("until:")
            certs[alias]["valid_from"] = parts[0].split("from")[1].strip()
            certs[alias]["valid_to"] = parts[1].strip()
        elif "SHA1:" in line and alias:
            certs[alias]["sha1"] = line.split("SHA1:")[1].strip()

    return certs


def read_endpoint_certs():
    data = {}

    if not os.path.isdir(ENDPOINT_PUBLIC_PATH):
        return data

    for f in os.listdir(ENDPOINT_PUBLIC_PATH):
        full = os.path.join(ENDPOINT_PUBLIC_PATH, f)

        try:
            if f.endswith(".jks"):
                out = run([
                    "keytool", "-list", "-v",
                    "-keystore", full,
                    "-storepass", "password"
                ])
                data[f] = parse_keytool_output(out)

            elif f.endswith((".crt", ".cer", ".pem")):
                out = run([
                    "openssl", "x509", "-in", full,
                    "-noout", "-startdate", "-enddate", "-fingerprint"
                ])
                data[f] = parse_openssl_output(out)
        except:
            data[f] = {"error": "Unable to read"}

    return data


# ---------- IBM ACE / IIB ----------

def get_ace_info():
    info = {}
    try:
        nodes = run(["mqsilist"]).splitlines()
        for node in nodes:
            node = node.strip()
            info[node] = {"execution_groups": []}

            egs = run(["mqsilist", node]).splitlines()
            for eg in egs:
                info[node]["execution_groups"].append(eg.strip())
    except:
        info["error"] = "ACE not accessible"

    return info


# ---------- IBM MQ ----------

def get_mq_info():
    info = {}

    try:
        qms = run(["dspmq"]).splitlines()
        for qm in qms:
            name = qm.split("(")[1].split(")")[0]
            status = qm.split("STATUS(")[1].split(")")[0]
            info[name] = {"status": status}
    except:
        info["error"] = "MQ not accessible"

    return info


# ---------- MAIN ----------

def main():
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    snapshot = {
        "timestamp": datetime.now().isoformat(),
        "system": get_system_info(),
        "certificates": read_endpoint_certs(),
        "ace": get_ace_info(),
        "mq": get_mq_info(),
    }

    server_ip = snapshot["system"]["ip"]
    outfile = f"{OUTPUT_DIR}/{server_ip}.json"

    with open(outfile, "w") as f:
        json.dump(snapshot, f, indent=2)

    print(f"Generated: {outfile}")


if __name__ == "__main__":
    main()
