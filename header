import React, { useState, useRef, useEffect } from 'react';
import ProfileIcon from './ProfileIcon';
import logo from '../assets/tcs.png';
import { postAnnouncement } from './postNewApi';

export default function Header({ username, onLogout, showProfileIcon = true }) {
  const [menuOpen, setMenuOpen] = useState(false);
  const [env, setEnv] = useState('');
  const [setup, setSetup] = useState('');
  const [showAnnouncementModal, setShowAnnouncementModal] = useState(false);
  const [announcement, setAnnouncement] = useState('');
  const [announcementTime, setAnnouncementTime] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [announcementMsg, setAnnouncementMsg] = useState('');
  const [showAlertModal, setShowAlertModal] = useState(false);
  const [alertData, setAlertData] = useState(null);

  const dropdownRef = useRef();

  // Fetch environment info
  useEffect(() => {
    const fetchEnvAndSetup = async () => {
      try {
        const response = await fetch('https://10.191.171.12:5443/PyPortal/env');
        const data = await response.json();
        setEnv(data.Environment);
        setSetup(data.PRDRSetup);
      } catch (error) {
        console.error('Failed to fetch environment:', error);
        setEnv('');
      }
    };
    fetchEnvAndSetup();
  }, []);

  // Close menu on outside click
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setMenuOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const getMarqueeText = () => {
    if (env === 'PR' && setup === 'YES') return 'PR DR SETUP is live!!';
    if (env === 'DR' && setup === 'YES') return 'PR DR SETUP is live!!';
    if (env === 'PR') return 'PR is live now!! ';
    if (env === 'DR') return 'DR is live now!! ';
    return 'Welcome to EIS INFRA ';
  };

  // Announcement Modal handlers
  const handleOpenAnnouncement = () => {
    setAnnouncement('');
    setAnnouncementTime('');
    setAnnouncementMsg('');
    setShowAnnouncementModal(true);
    setMenuOpen(false);
  };

  const handleCloseAnnouncement = () => {
    setShowAnnouncementModal(false);
    setAnnouncement('');
    setAnnouncementTime('');
    setAnnouncementMsg('');
  };

  const handleSubmitAnnouncement = async (e) => {
    e.preventDefault();
    setSubmitting(true);
    setAnnouncementMsg('');
    if (!announcement.trim()) {
      setAnnouncementMsg('Announcement cannot be empty.');
      setSubmitting(false);
      return;
    }
    try {
      await postAnnouncement(announcement, announcementTime);
      setAnnouncementMsg('Announcement posted successfully!');
      setTimeout(() => {
        handleCloseAnnouncement();
      }, 1200);
    } catch (err) {
      setAnnouncementMsg('Error posting announcement. Please try again.');
    }
    setSubmitting(false);
  };

  // Alert Modal handlers
  const handleOpenAlert = () => {
    // Here you should fetch your alert data if needed.
    // For now, we'll use mock data for demonstration.
    const mockAlert = {
      Type: 'System Alert',
      Time: new Date().toLocaleString(),
      Message: 'This is a demo alert! Please check system status.',
      Severity: 'High',
      Source: 'Monitoring Service'
    };
    setAlertData(mockAlert);
    setShowAlertModal(true);
  };

  const handleCloseAlert = () => {
    setShowAlertModal(false);
    setAlertData(null);
  };

  return (
    <div
      className="container"
      style={{
        paddingTop: '19px',
        paddingBottom: '19px',
        position: 'relative',
        background: 'linear-gradient(135deg, #667eea, #764ba2)',
        background: 'linear-gradient(180deg, #1b1035, #2e1442, #3a1a58)',
        color: '#ffffff',
        overflow: 'visible'
      }}
    >
      {/* Marquee Background */}
      <div
        style={{
          position: 'absolute',
          width: '100%',
          top: 0,
          left: 0,
          right: 0,
          height: '100%',
          display: 'flex',
          alignItems: 'flex-end',
          zIndex: 1
        }}
      >
        <marquee
          behavior="scroll"
          direction="left"
          scrollamount="12"
          style={{
            backgroundColor: 'transparent',
            fontWeight: 'bold',
            opacity: 0.4
          }}
        >
          {Array(1000)
            .fill(getMarqueeText())
            .map((text, index) => (
              <span key={index} style={{ marginRight: '150px' }}>
                {text}
              </span>
            ))}
        </marquee>
      </div>

      {/* Header Content */}
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          width: '100%',
          position: 'relative',
          zIndex: 3,
          padding: '0 20px'
        }}
      >
        {/* Logo */}
        <div style={{ display: 'flex', alignItems: 'center' }}>
          <img
            className="logo"
            src={logo}
            alt="TCS Company Logo"
            style={{ height: '40px', marginRight: '20px' }}
          />
        </div>

        {/* Title */}
        <h1 style={{ margin: 0, fontSize: 'clamp(1.5rem, 2vw, 2.5rem)' }}>
          EIS INFRA HOME
        </h1>

        {/* Profile, Alert & Dropdown */}
        <div
          style={{ display: 'flex', alignItems: 'center', position: 'relative' }}
          ref={dropdownRef}
        >
          {/* Alert Button */}
          <button
            onClick={handleOpenAlert}
            style={{
              marginLeft: '10px',
              padding: '7px 18px',
              fontSize: 15,
              fontWeight: 700,
              background: 'linear-gradient(90deg, #ff416c, #ff4b2b)',
              color: '#fff',
              border: 'none',
              borderRadius: 8,
              boxShadow: '0 2px 8px rgba(255, 65, 108, 0.15)',
              cursor: 'pointer',
              outline: 'none',
              transition: 'transform 0.15s, box-shadow 0.15s',
              textShadow: '0px 1px 6px #000, 0px 0px 12px #ff5e62b4',
              letterSpacing: 1,
              zIndex: 10
            }}
            aria-label="View alerts"
          >
            &#9888; Alerts
          </button>
          {showProfileIcon && username && (
            <>
              <div
                onClick={() => setMenuOpen(!menuOpen)}
                style={{ cursor: 'pointer', marginLeft: '13px' }}
                aria-label="Profile menu toggle"
              >
                <ProfileIcon sender="user" />
              </div>
              {menuOpen && (
                <div
                  style={{
                    position: 'absolute',
                    top: '50px',
                    right: 0,
                    background: '#1e1e1e',
                    color: '#fff',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
                    borderRadius: '6px',
                    padding: '10px',
                    zIndex: 9999,
                    minWidth: '150px',
                  }}
                  aria-label="Dropdown menu"
                >
                  <div
                    style={{ padding: '8px 12px', cursor: 'pointer', borderBottom: '1px solid #333' }}
                    onClick={handleOpenAnnouncement}
                    aria-label="Make an announcement"
                  >
                    Make an Announcement
                  </div>
                  <div
                    style={{ padding: '8px 12px', cursor: 'pointer' }}
                    onClick={onLogout}
                    aria-label="Logout button"
                  >
                    Logout
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* Announcement Modal */}
      {showAnnouncementModal && (
        <div
          style={{
            position: 'fixed',
            top: 0, left: 0, width: '100vw', height: '100vh',
            background: 'rgba(0,0,0,0.45)',
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            zIndex: 99999,
          }}
        >
          <form
            onSubmit={handleSubmitAnnouncement}
            style={{
              background: '#221d2e',
              color: '#fff',
              padding: '30px 24px 18px',
              borderRadius: '10px',
              width: '350px',
              boxShadow: '0 6px 24px rgba(0,0,0,0.20)'
            }}
          >
            <h2 style={{ marginTop: 0, marginBottom: 16, fontWeight: 600, fontSize: 20 }}>Make an Announcement</h2>
            <label style={{ display: 'block', marginBottom: 8 }}>
              Announcement:
              <textarea
                value={announcement}
                onChange={e => setAnnouncement(e.target.value)}
                rows={3}
                required
                style={{ width: '100%', marginTop: 4, borderRadius: 4, padding: 6, fontSize: 15, resize: 'vertical', marginBottom: 14 }}
                placeholder="Enter announcement..."
              />
            </label>
            <label style={{ display: 'block', marginBottom: 12 }}>
              Duration (hours):
              <input
                type="number"
                value={announcementTime}
                min={1}
                max={240}
                step={1}
                onChange={e => setAnnouncementTime(e.target.value)}
                placeholder="(Default 24 hours)"
                style={{ width: '100%', borderRadius: 3, padding: 6, fontSize: 15, marginTop: 4 }}
              />
            </label>
            <div style={{ display: 'flex', gap: 10, marginTop: 10 }}>
              <button
                type="submit"
                disabled={submitting}
                style={{
                  background: '#4d70ff',
                  color: '#fff',
                  border: 'none',
                  borderRadius: 4,
                  padding: '7px 18px',
                  fontSize: 15,
                  cursor: submitting ? 'not-allowed' : 'pointer'
                }}
              >
                {submitting ? 'Submitting...' : 'Submit'}
              </button>
              <button
                type="button"
                onClick={handleCloseAnnouncement}
                style={{
                  background: '#3a1a58',
                  color: '#fff',
                  border: 'none',
                  borderRadius: 4,
                  padding: '7px 18px',
                  fontSize: 15,
                  cursor: 'pointer'
                }}
                disabled={submitting}
              >
                Cancel
              </button>
            </div>
            {announcementMsg && (
              <div style={{ marginTop: 13, color: announcementMsg.includes('success') ? '#7fff7f' : '#ff7f7f', fontWeight: 500 }}>
                {announcementMsg}
              </div>
            )}
          </form>
        </div>
      )}

      {/* Alert Modal */}
      {showAlertModal && (
        <div
          style={{
            position: 'fixed',
            top: 0, left: 0, width: '100vw', height: '100vh',
            background: 'rgba(0,0,0,0.60)',
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            zIndex: 99998,
          }}
        >
          <div
            style={{
              background: 'linear-gradient(135deg, #ff416c 60%, #ff4b2b 100%)',
              color: '#fff',
              padding: '35px 34px 27px',
              borderRadius: '15px',
              minWidth: '410px',
              maxWidth: '95vw',
              boxShadow: '0 12px 36px rgba(255,65,108,0.25), 0 2px 16px #0007',
              position: 'relative',
              overflow: 'hidden'
            }}
          >
            <button
              onClick={handleCloseAlert}
              style={{
                position: 'absolute',
                top: 13,
                right: 14,
                background: 'none',
                color: '#fff',
                border: 'none',
                fontSize: 24,
                fontWeight: 'bold',
                cursor: 'pointer',
                textShadow: '0 2px 8px #000a',
                zIndex: 100
              }}
              aria-label="Close alert modal"
            >
              &times;
            </button>
            <h2 style={{
              marginTop: 0,
              marginBottom: 22,
              fontWeight: 700,
              fontSize: 22,
              textAlign: 'center',
              letterSpacing: 1
            }}>
              Alert Details
            </h2>
            {alertData ? (
              <table
                style={{
                  width: '100%',
                  borderCollapse: 'collapse',
                  background: 'rgba(0,0,0,0.14)',
                  borderRadius: 12,
                  overflow: 'hidden',
                  boxShadow: '0 1px 4px #0003'
                }}
              >
                <thead>
                  <tr>
                    {Object.keys(alertData).map((key) =>
                      <th
                        key={key}
                        style={{
                          padding: '10px 8px',
                          background: 'rgba(255,255,255,0.09)',
                          color: '#fff',
                          fontWeight: 600,
                          borderBottom: '2px solid #ff416c99',
                          textAlign: 'left'
                        }}
                      >
                        {key}
                      </th>
                    )}
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    {Object.values(alertData).map((val, i) =>
                      <td
                        key={i}
                        style={{
                          padding: '10px 8px',
                          background: 'rgba(255,255,255,0.04)',
                          color: '#fff',
                          borderBottom: '1px solid #ff416c25'
                        }}
                      >
                        {val}
                      </td>
                    )}
                  </tr>
                </tbody>
              </table>
            ) : (
              <div style={{ textAlign: 'center', fontSize: 17, fontWeight: 500 }}>
                No alert data available.
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
