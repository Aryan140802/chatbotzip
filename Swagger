import { useState, useCallback, useRef } from "react";

const ALL_IPS = [
  "10.177.40.101","10.177.40.102","10.177.40.103","10.177.40.104","10.177.40.105",
  "10.177.40.106","10.177.40.10","10.177.40.110","10.177.40.111","10.177.40.112",
  "10.177.40.113","10.177.40.114","10.177.40.115","10.177.40.11","10.177.40.12",
  "10.177.40.131","10.177.40.132","10.177.40.133","10.177.40.134","10.177.40.135",
  "10.177.40.13","10.177.40.141","10.177.40.142","10.177.40.143","10.177.40.144",
  "10.177.40.145","10.177.40.146","10.177.40.14","10.177.40.155","10.177.40.156",
  "10.177.40.157","10.177.40.158","10.177.40.159","10.177.40.15","10.177.40.160",
  "10.177.40.163","10.177.40.164","10.177.40.165","10.177.40.166","10.177.40.167",
  "10.177.40.168","10.177.40.169","10.177.40.170","10.177.40.171","10.177.40.173",
  "10.177.40.174","10.177.40.175","10.177.40.176","10.177.40.177","10.177.40.178",
  "10.177.40.190","10.177.40.191","10.177.40.192","10.177.40.194","10.177.40.195",
  "10.177.40.196","10.177.40.197","10.177.40.230","10.177.40.231","10.177.40.232",
  "10.177.40.233","10.177.40.234","10.177.40.235","10.177.40.31","10.177.40.32",
  "10.177.40.33","10.177.40.34","10.177.40.41","10.177.40.42","10.177.40.43",
  "10.177.40.44","10.177.40.45","10.177.40.55","10.177.40.56","10.177.40.57",
  "10.177.40.58","10.177.40.59","10.177.40.63","10.177.40.64","10.177.40.65",
  "10.177.40.66","10.177.40.67","10.177.40.68","10.177.40.69","10.177.40.70",
  "10.177.40.71","10.177.40.73","10.177.40.74","10.177.40.75","10.177.40.81",
  "10.177.40.82","10.177.40.83","10.177.40.84","10.177.40.85","10.177.40.86",
  "10.177.40.87","10.177.40.88","10.177.40.89",
  "10.177.41.101","10.177.41.102","10.177.41.10","10.177.41.110","10.177.41.111",
  "10.177.41.112","10.177.41.113","10.177.41.114","10.177.41.115","10.177.41.11",
  "10.177.41.12","10.177.41.131","10.177.41.132","10.177.41.133","10.177.41.134",
  "10.177.41.135","10.177.41.13","10.177.41.141","10.177.41.142","10.177.41.143",
  "10.177.41.144","10.177.41.145","10.177.41.146","10.177.41.14","10.177.41.155",
  "10.177.41.156","10.177.41.157","10.177.41.158","10.177.41.159","10.177.41.15",
  "10.177.41.160","10.177.41.163","10.177.41.164","10.177.41.165","10.177.41.166",
  "10.177.41.168","10.177.41.169","10.177.41.170","10.177.41.171","10.177.41.173",
  "10.177.41.174","10.177.41.175","10.177.41.176","10.177.41.190","10.177.41.191",
  "10.177.41.192","10.177.41.194","10.177.41.195","10.177.41.196","10.177.41.197",
  "10.177.41.20","10.177.41.21","10.177.41.230","10.177.41.231","10.177.41.232",
  "10.177.41.233","10.177.41.234","10.177.41.31","10.177.41.32","10.177.41.33",
  "10.177.41.34","10.177.41.41","10.177.41.42","10.177.41.43","10.177.41.44",
  "10.177.41.45","10.177.41.55","10.177.41.56","10.177.41.57","10.177.41.58",
  "10.177.41.59","10.177.41.63","10.177.41.64","10.177.41.65","10.177.41.66",
  "10.177.41.67","10.177.41.68","10.177.41.69","10.177.41.70","10.177.41.71",
  "10.177.41.73","10.177.41.74","10.177.41.75",
  "10.188.24.101","10.188.24.102","10.188.24.103","10.188.24.104","10.188.24.105",
  "10.188.24.106","10.188.24.10","10.188.24.110","10.188.24.111","10.188.24.112",
  "10.188.24.113","10.188.24.114","10.188.24.115","10.188.24.11","10.188.24.12",
  "10.188.24.131","10.188.24.132","10.188.24.133","10.188.24.134","10.188.24.135",
  "10.188.24.13","10.188.24.141","10.188.24.142","10.188.24.143","10.188.24.144",
  "10.188.24.145","10.188.24.146","10.188.24.14","10.188.24.155","10.188.24.156",
  "10.188.24.157","10.188.24.158","10.188.24.159","10.188.24.15","10.188.24.160",
  "10.188.24.163","10.188.24.164","10.188.24.165","10.188.24.166","10.188.24.167",
  "10.188.24.168","10.188.24.169","10.188.24.170","10.188.24.171","10.188.24.173",
  "10.188.24.174","10.188.24.175","10.188.24.176","10.188.24.177","10.188.24.178",
  "10.188.24.190","10.188.24.191","10.188.24.192","10.188.24.194","10.188.24.195",
  "10.188.24.196","10.188.24.197","10.188.24.230","10.188.24.231","10.188.24.232",
  "10.188.24.234","10.188.24.31","10.188.24.32","10.188.24.33","10.188.24.34",
  "10.188.24.41","10.188.24.42","10.188.24.43","10.188.24.44","10.188.24.45",
  "10.188.24.55","10.188.24.56","10.188.24.57","10.188.24.58","10.188.24.59",
  "10.188.24.63","10.188.24.64","10.188.24.65","10.188.24.66","10.188.24.67",
  "10.188.24.68","10.188.24.69","10.188.24.70","10.188.24.71","10.188.24.73",
  "10.188.24.74","10.188.24.75","10.188.24.77","10.188.24.78",
  "10.188.25.101","10.188.25.102","10.188.25.10","10.188.25.110","10.188.25.111",
  "10.188.25.112","10.188.25.113","10.188.25.114","10.188.25.115","10.188.25.11",
  "10.188.25.12","10.188.25.131","10.188.25.132","10.188.25.133","10.188.25.134",
  "10.188.25.135","10.188.25.13","10.188.25.141","10.188.25.142","10.188.25.143",
  "10.188.25.144","10.188.25.145","10.188.25.146","10.188.25.14","10.188.25.155",
  "10.188.25.156","10.188.25.157","10.188.25.158","10.188.25.159","10.188.25.15",
  "10.188.25.160","10.188.25.164","10.188.25.165","10.188.25.166","10.188.25.167",
  "10.188.25.168","10.188.25.169","10.188.25.170","10.188.25.171","10.188.25.173",
  "10.188.25.174","10.188.25.175","10.188.25.176","10.188.25.190","10.188.25.191",
  "10.188.25.192","10.188.25.194","10.188.25.195","10.188.25.196","10.188.25.197",
  "10.188.25.20","10.188.25.21","10.188.25.230","10.188.25.232","10.188.25.234",
  "10.188.25.31","10.188.25.32","10.188.25.33","10.188.25.34","10.188.25.41",
  "10.188.25.42","10.188.25.43","10.188.25.44","10.188.25.45","10.188.25.55",
  "10.188.25.56","10.188.25.57","10.188.25.58","10.188.25.59","10.188.25.63",
  "10.188.25.64","10.188.25.65","10.188.25.66","10.188.25.67","10.188.25.68",
  "10.188.25.69","10.188.25.70","10.188.25.71","10.188.25.73","10.188.25.74",
  "10.188.25.75","10.188.25.80"
];

function getPairs() {
  const pairs = [];
  for (const pr of ALL_IPS.filter(ip => ip.startsWith("10.188."))) {
    const parts = pr.split(".");
    const drThird = parts[2] === "24" ? "40" : "41";
    const dr = `10.177.${drThird}.${parts[3]}`;
    if (ALL_IPS.includes(dr)) pairs.push({ pr, dr, id: `${pr}|${dr}` });
  }
  return pairs;
}

const PAIRS = getPairs();
const API_URL = "https://10.191.171.12:5443/EISHOME/prdSync/checkSyncIPSpecific/";

const C = {
  bg: "#070910", surface: "#0b0d16", card: "#0f1220",
  cardHover: "#131628", border: "#181e30", borderMid: "#1f2840",
  accent: "#4f8ef7", accentDim: "rgba(79,142,247,0.15)",
  green: "#00d68f", greenBg: "rgba(0,214,143,0.08)", greenBorder: "rgba(0,214,143,0.22)",
  red: "#ff4060", redBg: "rgba(255,64,96,0.08)", redBorder: "rgba(255,64,96,0.22)",
  amber: "#f5a623", amberBg: "rgba(245,166,35,0.08)", amberBorder: "rgba(245,166,35,0.22)",
  text: "#d8e4f5", textSub: "#6b7fa6", textMuted: "#323d58",
};

const css = `
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: ${C.bg}; color: ${C.text}; font-family: 'Courier New', Courier, monospace; }
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: ${C.surface}; }
  ::-webkit-scrollbar-thumb { background: ${C.borderMid}; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: ${C.accent}; }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  @keyframes shimmer { 0%{background-position:-600px 0} 100%{background-position:600px 0} }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .fade-up { animation: fadeUp 0.2s ease forwards; }
  .fade-in { animation: fadeIn 0.2s ease forwards; }

  /* ── Cards ── */
  .sc {
    border-radius: 7px; border: 1px solid ${C.border};
    background: ${C.card}; cursor: pointer; position: relative; overflow: hidden;
    transition: transform 0.14s, border-color 0.14s, box-shadow 0.14s, background 0.14s;
    user-select: none; padding: 13px 13px 13px 17px;
  }
  .sc:hover { transform: translateY(-1px); background: ${C.cardHover}; }

  .sc.synced {
    border-color: ${C.greenBorder};
    background: linear-gradient(150deg, ${C.card} 55%, rgba(0,214,143,0.05));
  }
  .sc.synced:hover { border-color: rgba(0,214,143,0.45); box-shadow: 0 4px 22px rgba(0,214,143,0.09); }

  .sc.drifted {
    border-color: ${C.redBorder};
    background: linear-gradient(150deg, ${C.card} 55%, rgba(255,64,96,0.05));
  }
  .sc.drifted:hover { border-color: rgba(255,64,96,0.45); box-shadow: 0 4px 22px rgba(255,64,96,0.11); }

  .sc.errored {
    border-color: ${C.amberBorder};
    background: linear-gradient(150deg, ${C.card} 55%, rgba(245,166,35,0.04));
  }

  /* Left status bar */
  .sc-bar {
    position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
    border-radius: 7px 0 0 7px;
  }
  .sc-bar.synced  { background: ${C.green}; box-shadow: 0 0 10px ${C.green}88; }
  .sc-bar.drifted { background: ${C.red};   box-shadow: 0 0 10px ${C.red}88; }
  .sc-bar.errored { background: ${C.amber}; }
  .sc-bar.pending { background: ${C.borderMid}; }
  .sc-bar.loading { background: ${C.accent}; animation: blink 1s ease infinite; }

  /* Shimmer overlay while loading */
  .sc-shimmer {
    position: absolute; inset: 0; pointer-events: none; border-radius: 7px;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.025) 50%, transparent 100%);
    background-size: 600px 100%;
    animation: shimmer 1.5s infinite;
  }

  /* ── Status labels on cards ── */
  .slabel {
    font-size: 10px; font-weight: 700; letter-spacing: 0.09em;
    border-radius: 3px; padding: 2px 7px; display: inline-block;
  }
  .slabel.synced  { color: ${C.green}; background: ${C.greenBg}; border: 1px solid ${C.greenBorder}; }
  .slabel.drifted { color: ${C.red};   background: ${C.redBg};   border: 1px solid ${C.redBorder}; }
  .slabel.errored { color: ${C.amber}; background: ${C.amberBg}; border: 1px solid ${C.amberBorder}; }
  .slabel.loading { color: ${C.accent}; background: ${C.accentDim}; border: 1px solid rgba(79,142,247,0.3); }
  .slabel.pending { color: ${C.textMuted}; border: 1px solid ${C.border}; }

  /* ── Buttons ── */
  .btn {
    display: inline-flex; align-items: center; gap: 7px;
    border: none; border-radius: 6px; cursor: pointer;
    font-family: 'Courier New', monospace; font-size: 11px; font-weight: 700;
    letter-spacing: 0.08em; padding: 8px 16px; text-transform: uppercase;
    transition: all 0.13s;
  }
  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-primary { background: ${C.accent}; color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #3a78e8; box-shadow: 0 0 18px rgba(79,142,247,0.4); }
  .btn-ghost { background: transparent; color: ${C.textSub}; border: 1px solid ${C.border}; }
  .btn-ghost:hover:not(:disabled) { border-color: ${C.borderMid}; color: ${C.text}; }
  .btn-stop { background: ${C.redBg}; color: ${C.red}; border: 1px solid ${C.redBorder}; }
  .btn-stop:hover { background: rgba(255,64,96,0.15); }
  .btn-csv { background: ${C.greenBg}; color: ${C.green}; border: 1px solid ${C.greenBorder}; }
  .btn-csv:hover { background: rgba(0,214,143,0.14); }

  /* ── Filter pills ── */
  .fp {
    border: 1px solid ${C.border}; background: transparent; color: ${C.textSub};
    border-radius: 4px; padding: 4px 11px; font-family: 'Courier New', monospace;
    font-size: 11px; font-weight: 700; cursor: pointer;
    transition: all 0.13s; letter-spacing: 0.06em; text-transform: uppercase;
  }
  .fp:hover { border-color: ${C.borderMid}; color: ${C.text}; }
  .fp.on { background: ${C.accent}; border-color: ${C.accent}; color: #fff; }

  /* ── Search ── */
  .srch {
    background: ${C.card}; border: 1px solid ${C.border}; border-radius: 5px;
    color: ${C.text}; padding: 6px 12px; font-family: 'Courier New', monospace;
    font-size: 12px; outline: none; width: 200px; transition: border 0.13s;
  }
  .srch:focus { border-color: ${C.accent}; }
  .srch::placeholder { color: ${C.textMuted}; }

  /* ── Stat boxes ── */
  .stat { background: ${C.card}; border: 1px solid ${C.border}; border-radius: 7px; padding: 13px 16px; flex: 1; min-width: 95px; }
  .pbar { height: 2px; background: ${C.border}; border-radius: 1px; overflow: hidden; margin-top: 8px; }
  .pfill { height: 100%; border-radius: 1px; transition: width 0.5s ease; }

  /* ── Modal ── */
  .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.82); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(5px); }
  .modal { background:${C.surface}; border:1px solid ${C.borderMid}; border-radius:11px; width:100%; max-width:800px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 32px 100px rgba(0,0,0,0.75); }
  .mh { padding:18px 22px; border-bottom:1px solid ${C.border}; flex-shrink:0; display:flex; align-items:center; justify-content:space-between; }
  .mb { padding:20px 22px; overflow-y:auto; flex:1; }
  .mf { padding:13px 22px; border-top:1px solid ${C.border}; display:flex; gap:8px; justify-content:flex-end; flex-shrink:0; }

  /* ── Diff rows ── */
  .dr { background:${C.card}; border:1px solid ${C.border}; border-radius:6px; padding:11px 14px; margin-bottom:7px; }
  .dr.d2 { border-left:3px solid ${C.red}; }
  .dr.d1 { border-left:3px solid ${C.amber}; }

  .spin-anim { animation: spin 0.7s linear infinite; }
`;

// ─── Helpers ─────────────────────────────────────────────────────────────────
const oct = ip => ip.split(".")[3];

function downloadCSV(pairs, results) {
  const rows = [["PR IP","DR IP","Status","Differences (Missing in DR)","Differences (Missing in PR)","Error","Checked At"]];
  for (const p of pairs) {
    const r = results[p.id];
    if (!r) { rows.push([p.pr, p.dr,"PENDING","","","",""]); continue; }
    const d = r.data?.differences;
    rows.push([
      p.pr, p.dr,
      r.loading ? "CHECKING" : r.error ? "ERROR" : (r.data?.status || ""),
      d?.missing_in_env2?.length ?? "",
      d?.missing_in_env1?.length ?? "",
      r.error || "",
      r.timestamp || ""
    ]);
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = `sync_report_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
}

// ─── Card status helpers ──────────────────────────────────────────────────────
function cardState(r) {
  if (!r)           return "pending";
  if (r.loading)    return "loading";
  if (r.error)      return "errored";
  if (r.data?.status === "IN SYNC")     return "synced";
  if (r.data?.status === "NOT IN SYNC") return "drifted";
  return "pending";
}

const STATE_LABEL = {
  synced:  "IN SYNC",
  drifted: "OUT OF SYNC",
  errored: "ERROR",
  loading: "CHECKING",
  pending: "PENDING",
};

// ─── Components ───────────────────────────────────────────────────────────────

function Spinner({ size = 14, color = C.accent }) {
  return (
    <div className="spin-anim" style={{
      width: size, height: size,
      border: `2px solid ${C.border}`, borderTopColor: color,
      borderRadius: "50%", flexShrink: 0
    }} />
  );
}

function ServerCard({ pair, result, onClick }) {
  const state = cardState(result);
  const diff = result?.data?.differences;
  const diffCount = diff ? (diff.missing_in_env2?.length || 0) + (diff.missing_in_env1?.length || 0) : 0;

  let cardCls = "sc";
  if (state === "synced")  cardCls += " synced";
  if (state === "drifted") cardCls += " drifted";
  if (state === "errored") cardCls += " errored";

  return (
    <div className={cardCls} onClick={() => onClick(pair, result)}>
      <div className={`sc-bar ${state}`} />
      {state === "loading" && <div className="sc-shimmer" />}

      {/* Octet + status label */}
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 9 }}>
        <span style={{ fontSize: 20, fontWeight: 700, letterSpacing: "0.02em", color: C.text }}>
          .{oct(pair.pr)}
        </span>
        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
          {state === "loading" && <Spinner size={11} />}
          <span className={`slabel ${state}`}>{STATE_LABEL[state]}</span>
        </div>
      </div>

      {/* IPs */}
      <div style={{ fontSize: 11, lineHeight: 1.75, color: C.textMuted }}>
        <div>
          <span style={{ color: C.textMuted, fontSize: 10, letterSpacing: "0.07em", marginRight: 5 }}>PR</span>
          <span style={{ color: C.textSub }}>{pair.pr}</span>
        </div>
        <div>
          <span style={{ color: C.textMuted, fontSize: 10, letterSpacing: "0.07em", marginRight: 5 }}>DR</span>
          <span style={{ color: C.textSub }}>{pair.dr}</span>
        </div>
      </div>

      {/* Drift detail */}
      {state === "drifted" && diffCount > 0 && (
        <div style={{ marginTop: 8, fontSize: 11, color: C.red, fontWeight: 700 }}>
          {diffCount} difference{diffCount !== 1 ? "s" : ""}
        </div>
      )}
      {state === "errored" && (
        <div style={{ marginTop: 8, fontSize: 10, color: C.amber, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
          {result.error}
        </div>
      )}
    </div>
  );
}

function DiffSection({ items, type }) {
  if (!items?.length) return null;
  const isEnv2 = type === "env2";
  const color = isEnv2 ? C.red : C.amber;
  const label = isEnv2 ? "MISSING IN DR" : "MISSING IN PR";
  return (
    <div style={{ marginBottom: 20 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
        <span style={{ fontSize: 11, fontWeight: 700, color, letterSpacing: "0.08em" }}>{label}</span>
        <span style={{ fontSize: 11, color, background: color + "1a", border: `1px solid ${color}33`, borderRadius: 20, padding: "0 7px" }}>{items.length}</span>
      </div>
      {items.map((d, i) => (
        <div key={i} className={`dr ${isEnv2 ? "d2" : "d1"}`}>
          <div style={{ fontSize: 11, color: C.textSub, marginBottom: 6, wordBreak: "break-all", lineHeight: 1.55 }}>{d.location}</div>
          <div style={{ display: "flex", gap: 16, flexWrap: "wrap" }}>
            <span style={{ fontSize: 12 }}>
              <span style={{ color: C.textMuted }}>property </span>
              <span style={{ color: C.text, fontWeight: 700 }}>{d.property}</span>
            </span>
            {d.env1 !== undefined && (
              <span style={{ fontSize: 12 }}>
                <span style={{ color: C.textMuted }}>PR </span>
                <span style={{ color: C.green }}>{d.env1 || "(empty)"}</span>
              </span>
            )}
            {d.env2 !== undefined && (
              <span style={{ fontSize: 12 }}>
                <span style={{ color: C.textMuted }}>DR </span>
                <span style={{ color: C.red }}>{d.env2 || "(empty)"}</span>
              </span>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}

function DetailModal({ pair, result, onClose }) {
  const [rawOpen, setRawOpen] = useState(false);
  const data = result?.data;
  const status = data?.status;
  const isSynced = status === "IN SYNC";
  const diff = data?.differences;
  const totalDiff = (diff?.missing_in_env2?.length || 0) + (diff?.missing_in_env1?.length || 0);
  const state = cardState(result);

  return (
    <div className="overlay fade-in" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="modal fade-up">
        <div className="mh">
          <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
            <div style={{
              width: 3, height: 28, borderRadius: 2,
              background: state === "synced" ? C.green : state === "drifted" ? C.red : C.amber,
              boxShadow: `0 0 8px ${state === "synced" ? C.green : state === "drifted" ? C.red : C.amber}88`
            }} />
            <div>
              <div style={{ fontSize: 16, fontWeight: 700, letterSpacing: "0.04em" }}>
                Server Pair <span style={{ color: C.accent }}>.{oct(pair.pr)}</span>
                <span className={`slabel ${state}`} style={{ marginLeft: 12, verticalAlign: "middle" }}>{STATE_LABEL[state]}</span>
              </div>
              <div style={{ fontSize: 11, color: C.textMuted, marginTop: 3 }}>{result?.timestamp}</div>
            </div>
          </div>
          <button className="btn btn-ghost" onClick={onClose} style={{ padding: "3px 9px", fontSize: 15 }}>X</button>
        </div>

        <div className="mb">
          {result?.error && (
            <div style={{ background: C.amberBg, border: `1px solid ${C.amberBorder}`, borderRadius: 7, padding: "11px 15px", marginBottom: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: C.amber, letterSpacing: "0.07em", marginBottom: 3 }}>REQUEST FAILED</div>
              <div style={{ fontSize: 12, color: C.textSub }}>{result.error}</div>
            </div>
          )}

          {/* IP summary */}
          <div style={{ display: "flex", gap: 10, marginBottom: 18, flexWrap: "wrap" }}>
            {[
              { label: "PR SERVER", val: pair.pr, color: C.accent },
              { label: "DR SERVER", val: pair.dr, color: C.green },
              ...(totalDiff > 0 ? [{ label: "DIFFERENCES", val: `${totalDiff} found`, color: C.red }] : []),
            ].map(s => (
              <div key={s.label} style={{ flex: 1, minWidth: 150, background: C.card, border: `1px solid ${C.border}`, borderRadius: 7, padding: "11px 15px" }}>
                <div style={{ fontSize: 10, color: C.textMuted, fontWeight: 700, letterSpacing: "0.1em", marginBottom: 5 }}>{s.label}</div>
                <div style={{ fontSize: 13, color: s.color, fontWeight: 700, letterSpacing: "0.03em" }}>{s.val}</div>
              </div>
            ))}
          </div>

          {isSynced && (
            <div style={{ textAlign: "center", padding: "30px 0" }}>
              <div style={{ fontSize: 32, fontWeight: 700, color: C.green, letterSpacing: "0.05em", marginBottom: 8 }}>IN SYNC</div>
              <div style={{ fontSize: 13, color: C.textSub }}>No configuration drift detected between PR and DR</div>
            </div>
          )}

          {!isSynced && diff && (
            <>
              <DiffSection items={diff.missing_in_env2} type="env2" />
              <DiffSection items={diff.missing_in_env1} type="env1" />
            </>
          )}

          {data && (
            <div style={{ marginTop: 10 }}>
              <button className="btn btn-ghost" style={{ width: "100%", justifyContent: "center" }} onClick={() => setRawOpen(o => !o)}>
                {rawOpen ? "HIDE RAW RESPONSE" : "SHOW RAW RESPONSE"}
              </button>
              {rawOpen && (
                <pre style={{
                  marginTop: 8, background: C.bg, border: `1px solid ${C.border}`,
                  borderRadius: 7, padding: 13, fontSize: 11, color: C.textSub,
                  overflowX: "auto", whiteSpace: "pre-wrap", wordBreak: "break-all",
                  maxHeight: 250, overflowY: "auto"
                }}>
                  {JSON.stringify(data, null, 2)}
                </pre>
              )}
            </div>
          )}
        </div>

        <div className="mf">
          <button className="btn btn-ghost" onClick={onClose}>CLOSE</button>
        </div>
      </div>
    </div>
  );
}

// ─── App ─────────────────────────────────────────────────────────────────────
export default function App() {
  const [results, setResults] = useState({});
  const [modal, setModal] = useState(null);
  const [filter, setFilter] = useState("all");
  const [search, setSearch] = useState("");
  const [isRunning, setIsRunning] = useState(false);
  const abortRef = useRef(null);

  const updateResult = useCallback((id, patch) => {
    setResults(prev => ({ ...prev, [id]: { ...prev[id], ...patch } }));
  }, []);

  async function checkPair(pair, signal) {
    updateResult(pair.id, { loading: true, error: null, data: null });
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ip1: pair.pr, ip2: pair.dr }),
        signal,
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      updateResult(pair.id, { loading: false, data, timestamp: new Date().toLocaleString() });
    } catch (e) {
      if (e.name === "AbortError") return;
      updateResult(pair.id, { loading: false, error: e.message, timestamp: new Date().toLocaleString() });
    }
  }

  async function runAll() {
    const ctrl = new AbortController();
    abortRef.current = ctrl;
    setIsRunning(true);
    const fresh = {};
    PAIRS.forEach(p => { fresh[p.id] = { loading: true }; });
    setResults(fresh);
    let idx = 0;
    async function worker() {
      while (idx < PAIRS.length && !ctrl.signal.aborted) {
        const pair = PAIRS[idx++];
        await checkPair(pair, ctrl.signal);
      }
    }
    await Promise.all(Array.from({ length: 6 }, worker));
    setIsRunning(false);
  }

  function stopAll() {
    abortRef.current?.abort();
    setIsRunning(false);
    setResults(prev => {
      const next = { ...prev };
      for (const k of Object.keys(next)) {
        if (next[k]?.loading) next[k] = { ...next[k], loading: false, error: "Cancelled" };
      }
      return next;
    });
  }

  // Stats
  const vals = Object.values(results);
  const total      = PAIRS.length;
  const checked    = vals.filter(r => r && !r.loading && (r.data || r.error)).length;
  const synced     = vals.filter(r => r?.data?.status === "IN SYNC").length;
  const notSynced  = vals.filter(r => r?.data?.status === "NOT IN SYNC").length;
  const errors     = vals.filter(r => r?.error && !r.loading).length;
  const inProgress = vals.filter(r => r?.loading).length;

  const filteredPairs = PAIRS.filter(p => {
    const r = results[p.id];
    if (search) {
      const q = search.toLowerCase();
      if (!p.pr.includes(q) && !p.dr.includes(q) && !oct(p.pr).includes(q)) return false;
    }
    if (filter === "synced")     return r?.data?.status === "IN SYNC";
    if (filter === "not-synced") return r?.data?.status === "NOT IN SYNC";
    if (filter === "error")      return !!r?.error;
    if (filter === "pending")    return !r || r.loading;
    return true;
  });

  const groups = [
    { label: "SUBNET A  —  10.188.24.x (PR)  /  10.177.40.x (DR)", prefix: "10.188.24." },
    { label: "SUBNET B  —  10.188.25.x (PR)  /  10.177.41.x (DR)", prefix: "10.188.25." },
  ];

  return (
    <>
      <style>{css}</style>
      <div style={{ minHeight: "100vh" }}>

        {/* ── Header ── */}
        <header style={{
          background: C.surface, borderBottom: `1px solid ${C.border}`,
          padding: "0 26px", position: "sticky", top: 0, zIndex: 50,
          display: "flex", alignItems: "center", justifyContent: "space-between", height: 56, gap: 16
        }}>
          <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
            <div style={{ width: 3, height: 26, borderRadius: 2, background: `linear-gradient(180deg, ${C.accent}, #1a4fb5)` }} />
            <div>
              <div style={{ fontSize: 13, fontWeight: 700, letterSpacing: "0.12em", color: C.text }}>EIS SYNC PORTAL</div>
              <div style={{ fontSize: 10, color: C.textMuted, letterSpacing: "0.1em", marginTop: 1 }}>PR / DR SYNCHRONIZATION MONITOR</div>
            </div>
          </div>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            {checked > 0 && (
              <button className="btn btn-csv" onClick={() => downloadCSV(PAIRS, results)}>DOWNLOAD CSV</button>
            )}
            {isRunning
              ? <button className="btn btn-stop" onClick={stopAll}>STOP</button>
              : <button className="btn btn-primary" onClick={runAll}>CHECK ALL SERVERS</button>
            }
          </div>
        </header>

        <div style={{ padding: "22px 26px", maxWidth: 1800, margin: "0 auto" }}>

          {/* ── Stats ── */}
          <div style={{ display: "flex", gap: 10, marginBottom: 20, flexWrap: "wrap" }}>
            {[
              { label: "TOTAL",        val: total,      color: C.text },
              { label: "CHECKED",      val: checked,    color: C.accent,  pct: total   ? checked/total*100   : 0, pc: C.accent },
              { label: "IN SYNC",      val: synced,     color: C.green,   pct: checked ? synced/checked*100  : 0, pc: C.green },
              { label: "OUT OF SYNC",  val: notSynced,  color: C.red,     pct: checked ? notSynced/checked*100 : 0, pc: C.red },
              { label: "ERRORS",       val: errors,     color: C.amber },
              { label: "IN PROGRESS",  val: inProgress, color: C.textSub },
            ].map(s => (
              <div key={s.label} className="stat">
                <div style={{ fontSize: 10, color: C.textMuted, fontWeight: 700, letterSpacing: "0.1em", marginBottom: 3 }}>{s.label}</div>
                <div style={{ fontSize: 26, fontWeight: 700, color: s.color, lineHeight: 1.1 }}>{s.val}</div>
                {s.pct !== undefined && (
                  <div className="pbar"><div className="pfill" style={{ width: `${s.pct}%`, background: s.pc }} /></div>
                )}
              </div>
            ))}
          </div>

          {/* ── Legend + hint ── */}
          <div style={{ display: "flex", alignItems: "center", gap: 20, marginBottom: 16, flexWrap: "wrap" }}>
            {[
              { color: C.green, label: "In Sync" },
              { color: C.red,   label: "Out of Sync" },
              { color: C.amber, label: "Error" },
              { color: C.borderMid, label: "Pending" },
            ].map(l => (
              <div key={l.label} style={{ display: "flex", alignItems: "center", gap: 7 }}>
                <div style={{ width: 9, height: 9, borderRadius: "50%", background: l.color, flexShrink: 0,
                  boxShadow: l.color !== C.borderMid ? `0 0 6px ${l.color}` : "none" }} />
                <span style={{ fontSize: 11, color: C.textSub }}>{l.label}</span>
              </div>
            ))}
            <span style={{ marginLeft: "auto", fontSize: 11, color: C.textMuted }}>Click any card to view full diff details</span>
          </div>

          {/* ── Filters ── */}
          <div style={{ display: "flex", gap: 8, marginBottom: 20, alignItems: "center", flexWrap: "wrap" }}>
            <input className="srch" type="text" placeholder="Search by IP or octet" value={search} onChange={e => setSearch(e.target.value)} />
            <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
              {[["all","ALL"],["synced","IN SYNC"],["not-synced","OUT OF SYNC"],["error","ERROR"],["pending","PENDING"]].map(([v, l]) => (
                <button key={v} className={`fp${filter === v ? " on" : ""}`} onClick={() => setFilter(v)}>{l}</button>
              ))}
            </div>
            <span style={{ marginLeft: "auto", fontSize: 11, color: C.textMuted }}>{filteredPairs.length} of {total} pairs</span>
          </div>

          {/* ── Server groups ── */}
          {groups.map(g => {
            const gp = filteredPairs.filter(p => p.pr.startsWith(g.prefix));
            if (!gp.length) return null;
            const gs = gp.filter(p => results[p.id]?.data?.status === "IN SYNC").length;
            const gd = gp.filter(p => results[p.id]?.data?.status === "NOT IN SYNC").length;

            return (
              <div key={g.label} style={{ marginBottom: 34 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 14, marginBottom: 14 }}>
                  <span style={{ fontSize: 11, fontWeight: 700, color: C.textSub, letterSpacing: "0.09em", whiteSpace: "nowrap" }}>{g.label}</span>
                  <div style={{ flex: 1, height: 1, background: C.border }} />
                  <span style={{ fontSize: 11, color: C.green }}>{gs} synced</span>
                  <span style={{ fontSize: 11, color: gd > 0 ? C.red : C.textMuted }}>{gd} drifted</span>
                  <span style={{ fontSize: 11, color: C.textMuted }}>{gp.length} pairs</span>
                </div>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(195px, 1fr))", gap: 9 }}>
                  {gp.map(pair => (
                    <ServerCard key={pair.id} pair={pair} result={results[pair.id]}
                      onClick={(p, r) => {
                        if (!r) { checkPair(p, new AbortController().signal); return; }
                        setModal({ pair: p, result: r });
                      }}
                    />
                  ))}
                </div>
              </div>
            );
          })}

          {filteredPairs.length === 0 && (
            <div style={{ textAlign: "center", padding: "60px 0", color: C.textMuted, letterSpacing: "0.06em" }}>
              No servers match the current filter
            </div>
          )}
        </div>

        {modal && <DetailModal pair={modal.pair} result={modal.result} onClose={() => setModal(null)} />}
      </div>
    </>
  );
}
