import '../styles/GraphCarousel.css';
import React, { useState, useEffect } from "react";
import {
  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
} from 'recharts';
import Download from '../assets/down-arrow.png';
import {
  getServiceSys, getServiceExp, getIpwiseExp, getIpwiseSys, getPortwiseSys, getPortwiseExp
} from "../api/PostApi";

const GraphCarousel = () => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [paused, setPaused] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  
  // State for each data set
  const [serviceSysData, setServiceSysData] = useState([]);
  const [serviceExpData, setServiceExpData] = useState([]);
  const [ipwiseSysData, setIpwiseSysData] = useState([]);
  const [ipwiseExpData, setIpwiseExpData] = useState([]);
  const [portwiseSysData, setPortwiseSysData] = useState([]);
  const [portwiseExpData, setPortwiseExpData] = useState([]);

  // Function to convert data to CSV format
  const convertToCSV = (jsonData, sortBy = 'Hits') => {
    if (!jsonData || !jsonData.length) return '';

    // Sort data in descending order
    const sortedData = [...jsonData].sort((a, b) => b[sortBy] - a[sortBy]);

    const headers = Object.keys(sortedData[0]);
    const csvRows = [
      headers.join(','), // header row
      ...sortedData.map(row => headers.map(field => `"${row[field]}"`).join(','))
    ];

    return csvRows.join('\n');
  };

  // Download CSV function
  const downloadCSV = (data, filename = 'chart-data.csv') => {
    if (!data || !Array.isArray(data) || data.length === 0) {
      console.warn("No data available to download");
      return;
    }

    try {
      const csvContent = convertToCSV(data);
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up the URL object
      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 100);
    } catch (error) {
      console.error("Error downloading CSV:", error);
    }
  };

  // Fetch all data when component mounts
  useEffect(() => {
    const fetchAllData = async () => {
      setIsLoading(true);
      try {
        // Fetch each data set individually to better handle errors
        try {
          const serviceSysResponse = await getServiceSys();
          if (serviceSysResponse && serviceSysResponse.data) {
            setServiceSysData(Array.isArray(serviceSysResponse.data) ? serviceSysResponse.data : []);
          }
        } catch (error) {
          console.error("Error fetching service system data:", error);
          setServiceSysData([]);
        }
        
        try {
          const serviceExpResponse = await getServiceExp();
          if (serviceExpResponse && serviceExpResponse.data && serviceExpResponse.data.Service_wise_exp) {
            setServiceExpData(Array.isArray(serviceExpResponse.data.Service_wise_exp) ? 
              serviceExpResponse.data.Service_wise_exp : []);
          }
        } catch (error) {
          console.error("Error fetching service experience data:", error);
          setServiceExpData([]);
        }
        
        try {
          const ipwiseSysResponse = await getIpwiseSys();
          if (ipwiseSysResponse && ipwiseSysResponse.data) {
            setIpwiseSysData(Array.isArray(ipwiseSysResponse.data) ? ipwiseSysResponse.data : []);
          }
        } catch (error) {
          console.error("Error fetching IP-wise system data:", error);
          setIpwiseSysData([]);
        }
        
        try {
          const ipwiseExpResponse = await getIpwiseExp();
          if (ipwiseExpResponse && ipwiseExpResponse.data) {
            setIpwiseExpData(Array.isArray(ipwiseExpResponse.data) ? ipwiseExpResponse.data : []);
          }
        } catch (error) {
          console.error("Error fetching IP-wise experience data:", error);
          setIpwiseExpData([]);
        }
        
        try {
          const portwiseSysResponse = await getPortwiseSys();
          if (portwiseSysResponse && portwiseSysResponse.data) {
            setPortwiseSysData(Array.isArray(portwiseSysResponse.data) ? portwiseSysResponse.data : []);
          }
        } catch (error) {
          console.error("Error fetching port-wise system data:", error);
          setPortwiseSysData([]);
        }
        
        try {
          const portwiseExpResponse = await getPortwiseExp();
          if (portwiseExpResponse && portwiseExpResponse.data) {
            setPortwiseExpData(Array.isArray(portwiseExpResponse.data) ? portwiseExpResponse.data : []);
          }
        } catch (error) {
          console.error("Error fetching port-wise experience data:", error);
          setPortwiseExpData([]);
        }
      } catch (error) {
        console.error("Error in data fetching process:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchAllData();
  }, []);

  // Helper function to safely get top N items from an array
  const getTopItems = (data, count = 10) => {
    if (!data || !Array.isArray(data)) return [];
    return [...data].sort((a, b) => b.Hits - a.Hits).slice(0, count);
  };

  // Prepare chart configurations
  const charts = [
    {
      title: 'Service System Usage',
      data: getTopItems(serviceSysData),
      chart: (
        <ResponsiveContainer>
          <BarChart data={getTopItems(serviceSysData)}>
            <CartesianGrid strokeDasharray="3 3" stroke="var(--border-color)" />
            <XAxis dataKey="Service_name" stroke="var(--text-color)" />
            <YAxis stroke="var(--text-color)" />
            <Tooltip />
            <Bar dataKey="Hits" fill="#f14f98" />
          </BarChart>
        </ResponsiveContainer>
      ),
    },
    {
      title: 'Service Experience Metrics',
      data: getTopItems(serviceExpData),
      chart: (
        <ResponsiveContainer>
          <LineChart data={getTopItems(serviceExpData)}>
            <CartesianGrid strokeDasharray="3 3" stroke="var(--border-color)" />
            <XAxis dataKey="Service_name" stroke="var(--text-color)" />
            <YAxis stroke="var(--text-color)" />
            <Tooltip />
            <Line type="monotone" dataKey="Hits" stroke="#7559f3" strokeWidth={3} />
          </LineChart>
        </ResponsiveContainer>
      ),
    },
    {
      title: 'IP-wise System Usage',
      data: getTopItems(ipwiseSysData),
      chart: (
        <ResponsiveContainer>
          <BarChart data={getTopItems(ipwiseSysData)}>
            <CartesianGrid strokeDasharray="3 3" stroke="var(--border-color)" />
            <XAxis dataKey="IP" stroke="var(--text-color)" />
            <YAxis stroke="var(--text-color)" />
            <Tooltip />
            <Bar dataKey="Hits" fill="#32a852" />
          </BarChart>
        </ResponsiveContainer>
      ),
    },
    {
      title: 'Port-wise System Usage',
      data: getTopItems(portwiseSysData),
      chart: (
        <ResponsiveContainer>
          <BarChart data={getTopItems(portwiseSysData)}>
            <CartesianGrid strokeDasharray="3 3" stroke="var(--border-color)" />
            <XAxis dataKey="Port" stroke="var(--text-color)" />
            <YAxis stroke="var(--text-color)" />
            <Tooltip />
            <Bar dataKey="Hits" fill="#3273a8" />
          </BarChart>
        </ResponsiveContainer>
      ),
    }
  ];

  // Navigation functions
  const goToSlide = (index) => {
    setCurrentIndex(index);
  };

  // Auto-play effect
  useEffect(() => {
    if (paused || charts.length <= 1) return;

    const interval = setInterval(() => {
      setCurrentIndex((prevIndex) =>
        prevIndex === charts.length - 1 ? 0 : prevIndex + 1
      );
    }, 5000);

    return () => clearInterval(interval);
  }, [paused, charts.length]);

  if (isLoading) {
    return <div className="loading">Loading charts...</div>;
  }

  return (
    <div className="carousel-container">
      <div className="carousel-header">
        <h2>{charts[currentIndex]?.title || 'Chart'}</h2>
        <div className="download-button-wrapper">
          <button
            className="download-button"
            onClick={() => downloadCSV(
              charts[currentIndex]?.data || [], 
              `${charts[currentIndex]?.title || 'chart-data'}.csv`
            )}
            disabled={!charts[currentIndex]?.data?.length}
          >
            <div className="logo-wrapper">
              <img
                className="logo"
                src={Download}
                alt="Download Icon"
                style={{ height: '36px', marginRight: '3px' }}
              />
            </div>
          </button>
        </div>
      </div>

      <div
        className="carousel-graph"
        onMouseEnter={() => setPaused(true)}
        onMouseLeave={() => setPaused(false)}
      >
        {charts.map((item, index) => (
          <div
            key={index}
            className={`chart-fade ${index === currentIndex ? 'active' : ''}`}
            style={{ display: index === currentIndex ? 'block' : 'none' }}
          >
            {item.chart}
          </div>
        ))}
      </div>

      <div className="carousel-dots">
        {charts.map((_, index) => (
          <span
            key={index}
            className={`dot ${index === currentIndex ? 'active' : ''} ${paused ? 'paused' : ''}`}
            onClick={() => goToSlide(index)}
          >
          </span>
        ))}
      </div>
    </div>
  );
};

export default GraphCarousel;
