<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Port Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 25px;
        }
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .port-badge {
            background-color: #20c997;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .server-ip {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #495057;
        }
        .broker-name {
            color: #212529;
            font-weight: 500;
        }
        .filter-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .loading-container {
            text-align: center;
            padding: 50px;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        .btn-download {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            padding: 10px 25px;
            font-weight: 500;
        }
        .btn-refresh {
            background: linear-gradient(135deg, #007bff 0%, #667eea 100%);
            border: none;
            padding: 10px 25px;
            font-weight: 500;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        th {
            background-color: #f8f9fa !important;
            font-weight: 600 !important;
            color: #495057;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 5px !important;
            margin: 0 2px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">ðŸ“Š Server Port Configuration</h1>
                    <p class="mb-0 opacity-75">Data loaded from: <code>/opt/apache-tomcat/webapps/Portdata/all_port_data.json</code></p>
                </div>
                <div>
                    <button id="refreshBtn" class="btn btn-light me-2">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button id="downloadBtn" class="btn btn-light">
                        <i class="bi bi-download"></i> Download Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row stats-card" id="statsContainer" style="display: none;">
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="serverCount">0</div>
                <div class="stat-label">Total Servers</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="brokerCount">0</div>
                <div class="stat-label">Total Brokers</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="portCount">0</div>
                <div class="stat-label">Unique Ports</div>
            </div>
            <div class="col-md-3 stat-item">
                <div class="stat-number" id="totalEntries">0</div>
                <div class="stat-label">Total Entries</div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="card loading-container" id="loadingState">
            <div class="card-body">
                <div class="spinner-border text-primary spinner" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3">Loading port data...</h4>
                <p class="text-muted">Fetching data from server</p>
            </div>
        </div>

        <!-- Error State -->
        <div class="alert alert-danger" id="errorState" style="display: none;">
            <h4><i class="bi bi-exclamation-triangle"></i> Error Loading Data</h4>
            <p id="errorMessage"></p>
            <button class="btn btn-outline-danger" onclick="location.reload()">Retry</button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Filters -->
            <div class="filter-container">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by IP, broker name, or port...">
                    </div>
                    <div class="col-md-3">
                        <label for="portFilter" class="form-label">Filter by Port</label>
                        <select id="portFilter" class="form-select">
                            <option value="">All Ports</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="serverFilter" class="form-label">Filter by Server</label>
                        <select id="serverFilter" class="form-select">
                            <option value="">All Servers</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button id="clearFilters" class="btn btn-outline-secondary w-100">Clear Filters</button>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="dataTable" class="table table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Server IP</th>
                                    <th>Broker Name</th>
                                    <th>Port</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Grouped View (Optional) -->
            <div class="card" id="groupedViewCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Grouped by Server</h5>
                </div>
                <div class="card-body" id="groupedViewContent">
                    <!-- Grouped content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // Global variables
        let portData = {};
        let dataTable = null;
        let allTableData = [];

        // Load data from JSON file
        async function loadData() {
            try {
                showLoading();
                
                // Fetch the JSON file directly
                const response = await fetch('/Portdata/all_port_data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                portData = await response.json();
                displayData();
                updateStatistics();
                populateFilters();
                
            } catch (error) {
                showError(`Failed to load data: ${error.message}`);
                console.error('Error details:', error);
            }
        }

        // Display data in table
        function displayData() {
            hideLoading();
            showMainContent();
            
            // Clear existing data
            allTableData = [];
            
            // Prepare table data
            Object.keys(portData).forEach(serverIp => {
                const brokers = portData[serverIp];
                brokers.forEach(brokerObj => {
                    const brokerName = Object.keys(brokerObj)[0];
                    const port = brokerObj[brokerName];
                    
                    allTableData.push({
                        serverIp: serverIp,
                        brokerName: brokerName,
                        port: port
                    });
                });
            });
            
            // Initialize or refresh DataTable
            if (dataTable) {
                dataTable.clear();
                dataTable.rows.add(allTableData);
                dataTable.draw();
            } else {
                dataTable = $('#dataTable').DataTable({
                    data: allTableData,
                    columns: [
                        { 
                            data: 'serverIp',
                            render: function(data) {
                                return `<span class="server-ip">${data}</span>`;
                            }
                        },
                        { 
                            data: 'brokerName',
                            render: function(data) {
                                return `<span class="broker-name">${data}</span>`;
                            }
                        },
                        { 
                            data: 'port',
                            render: function(data) {
                                return `<span class="port-badge">${data}</span>`;
                            }
                        }
                    ],
                    pageLength: 25,
                    responsive: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
                    language: {
                        search: "Filter:",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    }
                });
            }
        }

        // Update statistics
        function updateStatistics() {
            const serverCount = Object.keys(portData).length;
            let brokerCount = 0;
            const uniquePorts = new Set();
            
            Object.keys(portData).forEach(serverIp => {
                const brokers = portData[serverIp];
                brokerCount += brokers.length;
                brokers.forEach(brokerObj => {
                    const port = Object.values(brokerObj)[0];
                    uniquePorts.add(port);
                });
            });
            
            $('#serverCount').text(serverCount);
            $('#brokerCount').text(brokerCount);
            $('#portCount').text(uniquePorts.size);
            $('#totalEntries').text(allTableData.length);
            
            $('#statsContainer').show();
        }

        // Populate filter dropdowns
        function populateFilters() {
            const portSelect = $('#portFilter');
            const serverSelect = $('#serverFilter');
            
            // Clear existing options (except first)
            portSelect.find('option:not(:first)').remove();
            serverSelect.find('option:not(:first)').remove();
            
            // Get unique ports and servers
            const uniquePorts = new Set();
            const uniqueServers = new Set(Object.keys(portData));
            
            Object.keys(portData).forEach(serverIp => {
                const brokers = portData[serverIp];
                brokers.forEach(brokerObj => {
                    const port = Object.values(brokerObj)[0];
                    uniquePorts.add(port);
                });
            });
            
            // Add port options
            Array.from(uniquePorts).sort((a, b) => a - b).forEach(port => {
                portSelect.append(`<option value="${port}">${port}</option>`);
            });
            
            // Add server options
            Array.from(uniqueServers).sort().forEach(server => {
                serverSelect.append(`<option value="${server}">${server}</option>`);
            });
            
            // Add filter event listeners
            portSelect.on('change', applyFilters);
            serverSelect.on('change', applyFilters);
        }

        // Apply filters to table
        function applyFilters() {
            const portFilter = $('#portFilter').val();
            const serverFilter = $('#serverFilter').val();
            const searchTerm = $('#searchInput').val().toLowerCase();
            
            // Combine all filters
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const row = allTableData[dataIndex];
                
                // Port filter
                if (portFilter && row.port != portFilter) return false;
                
                // Server filter
                if (serverFilter && row.serverIp != serverFilter) return false;
                
                // Search filter
                if (searchTerm) {
                    const searchIn = row.serverIp + ' ' + row.brokerName + ' ' + row.port;
                    return searchIn.toLowerCase().includes(searchTerm);
                }
                
                return true;
            });
            
            dataTable.draw();
            
            // Remove the custom filter function
            $.fn.dataTable.ext.search.pop();
        }

        // Clear all filters
        function clearFilters() {
            $('#searchInput').val('');
            $('#portFilter').val('');
            $('#serverFilter').val('');
            dataTable.search('').draw();
            dataTable.column().search('').draw();
        }

        // Download as Excel
        function downloadExcel() {
            // Get filtered data (or all data)
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            
            // Prepare worksheet data
            const wsData = [
                ['Server IP', 'Broker Name', 'Port']
            ];
            
            filteredData.forEach(row => {
                wsData.push([row.serverIp, row.brokerName, row.port]);
            });
            
            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Port Data");
            
            // Style: Make header bold
            const wscols = [
                {wch: 20}, // Server IP column width
                {wch: 30}, // Broker Name column width
                {wch: 10}  // Port column width
            ];
            ws['!cols'] = wscols;
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
            const filename = `server_port_data_${timestamp}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
        }

        // UI Helper Functions
        function showLoading() {
            $('#loadingState').show();
            $('#errorState').hide();
            $('#mainContent').hide();
            $('#statsContainer').hide();
        }

        function hideLoading() {
            $('#loadingState').hide();
        }

        function showMainContent() {
            $('#mainContent').show();
        }

        function showError(message) {
            $('#loadingState').hide();
            $('#errorState').show();
            $('#errorMessage').text(message);
        }

        // Event Listeners
        $(document).ready(function() {
            // Initial load
            loadData();
            
            // Refresh button
            $('#refreshBtn').click(function() {
                loadData();
                $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...');
                setTimeout(() => {
                    $(this).html('<i class="bi bi-arrow-clockwise"></i> Refresh');
                }, 1000);
            });
            
            // Download button
            $('#downloadBtn').click(downloadExcel);
            
            // Search input
            $('#searchInput').on('keyup', function() {
                dataTable.search(this.value).draw();
            });
            
            // Clear filters button
            $('#clearFilters').click(clearFilters);
            
            // Keyboard shortcuts
            $(document).keydown(function(e) {
                // Ctrl+F to focus search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    $('#searchInput').focus();
                }
                // Ctrl+D to download
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    downloadExcel();
                }
                // Ctrl+R to refresh
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    loadData();
                }
            });
            
            // Add tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        // Add some Bootstrap icons (since we're not including the full Bootstrap icons)
        const style = document.createElement('style');
        style.textContent = `
            .bi {
                display: inline-block;
                vertical-align: -.125em;
            }
            .bi-arrow-clockwise::before {
                content: "âŸ³";
            }
            .bi-download::before {
                content: "â­³";
            }
            .bi-exclamation-triangle::before {
                content: "âš ";
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
