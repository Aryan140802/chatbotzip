<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Port Data Viewer</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3">üîå Server & Port Configuration</h1>
                    <p class="mb-0 opacity-90">Grouped view showing each server with its associated brokers and ports</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="refreshBtn" class="btn btn-light me-2">
                        <span class="btn-icon">üîÑ</span> Refresh
                    </button>
                    <button id="downloadBtn" class="btn btn-light">
                        <span class="btn-icon">‚≠≥</span> Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row" id="statsContainer" style="display: none;">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-value" id="serverCount">0</div>
                    <div class="stat-label">Servers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-value" id="brokerCount">0</div>
                    <div class="stat-label">Total Brokers</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-value" id="portCount">0</div>
                    <div class="stat-label">Unique Ports</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stat-value" id="avgBrokers">0</div>
                    <div class="stat-label">Avg Brokers/Server</div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingState">
            <div class="spinner"></div>
            <h4 class="mt-4">Loading Server Data...</h4>
            <p class="text-muted">Fetching from <code>/Portdata/all_port_data.json</code></p>
        </div>

        <!-- Error State -->
        <div class="alert alert-danger" id="errorState" style="display: none;">
            <h4><span class="error-icon">‚ö†Ô∏è</span> Error Loading Data</h4>
            <p id="errorMessage"></p>
            <button class="btn btn-outline-danger mt-2" onclick="loadData()">Retry</button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Filters -->
            <div class="filter-container">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control search-input" 
                               placeholder="Search servers, brokers, or ports...">
                    </div>
                    <div class="col-md-4">
                        <select id="portFilter" class="form-control search-input">
                            <option value="">Filter by Port...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="clearFilters" class="btn btn-outline-secondary w-100">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Port Summary -->
            <div class="port-summary">
                <h6 class="section-title"><span class="section-icon">üìä</span> Common Ports</h6>
                <div id="portTags">
                    <!-- Port tags will be added here -->
                </div>
            </div>

            <!-- Server Cards -->
            <div id="serversContainer">
                <!-- Server cards will be added here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <h4>No servers found</h4>
                <p>Try adjusting your search criteria</p>
            </div>
        </div>

        <!-- Port Highlight Instructions -->
        <div class="alert alert-info mt-4" style="display: none;" id="hint">
            <span class="hint-icon">üí°</span> <strong>Tip:</strong> Click on any port to highlight all occurrences of that port
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>


/* Variables */
:root {
    --primary-color: #4361ee;
    --secondary-color: #3a0ca3;
    --accent-color: #7209b7;
    --success-color: #4cc9f0;
    --warning-color: #ffd166;
    --danger-color: #ef476f;
    --light-bg: #f8f9fa;
    --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
    --border-radius: 12px;
    --transition: all 0.2s ease;
}

/* Base Styles */
body {
    background-color: #f5f7ff;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    padding: 20px;
    color: #333;
    line-height: 1.6;
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 30px;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
    box-shadow: var(--card-shadow);
}

/* Server Cards */
.server-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 20px;
    border: none;
    transition: var(--transition);
    overflow: hidden;
}

.server-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.server-header {
    background: linear-gradient(to right, #eef2ff, #e0e7ff);
    padding: 20px;
    border-bottom: 2px solid var(--primary-color);
    position: relative;
}

.server-ip {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--secondary-color);
    margin: 0;
}

.broker-count {
    background: var(--success-color);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Broker Items */
.broker-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f1f3f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
}

.broker-item:hover {
    background-color: #f9fafc;
}

.broker-item:last-child {
    border-bottom: none;
}

.broker-name {
    font-weight: 500;
    color: #495057;
    font-size: 1rem;
}

.port-display {
    background: linear-gradient(135deg, var(--accent-color), #f72585);
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-weight: 600;
    font-size: 1rem;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(114, 9, 183, 0.2);
    transition: var(--transition);
    cursor: pointer;
}

.port-display:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(114, 9, 183, 0.3);
}

/* Statistics Cards */
.stats-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 8px;
    font-weight: 500;
}

/* Port Summary */
.port-summary {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
}

.port-tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 6px 12px;
    border-radius: 20px;
    margin: 5px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: var(--transition);
    cursor: pointer;
}

.port-tag:hover {
    background: var(--success-color);
    color: white;
    transform: translateY(-2px);
}

/* Filter Container */
.filter-container {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--card-shadow);
}

.search-input {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 1rem;
    transition: var(--transition);
}

.search-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    outline: none;
}

/* Buttons */
.btn-light {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 500;
    transition: var(--transition);
}

.btn-light:hover {
    background: #f8f9fa;
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.btn-icon {
    margin-right: 5px;
}

/* Loading State */
.loading-container {
    text-align: center;
    padding: 50px 0;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e2e8f0;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Highlight Port */
.highlight-port {
    background: linear-gradient(135deg, var(--warning-color), var(--danger-color)) !important;
    color: white !important;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

/* Port Info */
.port-info {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    background: #f8fafc;
    border-radius: 8px;
    padding: 10px;
    margin-top: 5px;
    font-size: 0.9rem;
    color: #64748b;
}

/* Section Title */
.section-title {
    color: var(--secondary-color);
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.3rem;
}

.section-icon {
    margin-right: 8px;
}

/* Icons */
.error-icon {
    margin-right: 8px;
}

.hint-icon {
    margin-right: 8px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header {
        padding: 20px;
    }
    
    .server-header {
        padding: 15px;
    }
    
    .broker-item {
        padding: 12px 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .port-display {
        align-self: flex-end;
    }
    
    .filter-container .row {
        flex-direction: column;
        gap: 10px;
    }
    
    .filter-container .col-md-2,
    .filter-container .col-md-4,
    .filter-container .col-md-6 {
        width: 100%;
    }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
    :root {
        --primary-color: #5a6ff0;
        --secondary-color: #4a0db3;
        --light-bg: #1a1a2e;
    }
    
    body {
        background-color: #121212;
        color: #e0e0e0;
    }
    
    .server-card,
    .stats-card,
    .port-summary,
    .filter-container {
        background: #1e1e2e;
        color: #e0e0e0;
    }
    
    .broker-name {
        color: #d0d0d0;
    }
    
    .search-input {
        background: #2d2d44;
        border-color: #3d3d5c;
        color: #e0e0e0;
    }
    
    .search-input:focus {
        border-color: var(--primary-)
    }
}





// Global variables
let portData = {};
let allServers = [];
let selectedPort = null;

// Load data from JSON file
async function loadData() {
    try {
        showLoading();
        
        // Fetch the JSON file
        const response = await fetch('/Portdata/all_port_data.json');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        portData = await response.json();
        processData();
        
    } catch (error) {
        showError(`Failed to load data: ${error.message}`);
        console.error('Error details:', error);
    }
}

// Process and display data
function processData() {
    hideLoading();
    showMainContent();
    
    // Convert object to array and sort by IP
    allServers = Object.keys(portData)
        .map(ip => ({
            ip: ip,
            brokers: portData[ip]
        }))
        .sort((a, b) => {
            // Natural sort for IP addresses
            const ipToNum = ip => ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet), 0);
            return ipToNum(a.ip) - ipToNum(b.ip);
        });
    
    updateStatistics();
    populateFilters();
    displayServers();
    updatePortTags();
}

// Display servers as cards
function displayServers(filteredServers = allServers) {
    const container = document.getElementById('serversContainer');
    
    if (filteredServers.length === 0) {
        container.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    
    document.getElementById('emptyState').style.display = 'none';
    
    let html = '';
    
    filteredServers.forEach(server => {
        const brokerCount = server.brokers.length;
        
        html += `
            <div class="server-card">
                <div class="server-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="server-ip">${server.ip}</h3>
                            <small class="text-muted">${brokerCount} broker${brokerCount !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="broker-count">${brokerCount}</span>
                    </div>
                </div>
                <div class="server-content">
                    ${server.brokers.map(broker => {
                        const brokerName = Object.keys(broker)[0];
                        const port = broker[brokerName];
                        const isHighlighted = selectedPort === port ? 'highlight-port' : '';
                        
                        return `
                            <div class="broker-item">
                                <div>
                                    <div class="broker-name">${brokerName}</div>
                                    <div class="port-info">Port: ${port}</div>
                                </div>
                                <div class="port-display ${isHighlighted}" onclick="highlightPort(${port})" 
                                     data-port="${port}" data-broker="${brokerName}" data-server="${server.ip}">
                                    ${port}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Show hint after first render
    if (document.getElementById('hint').style.display === 'none') {
        setTimeout(() => {
            document.getElementById('hint').style.display = 'block';
        }, 1000);
    }
}

// Highlight all occurrences of a port
function highlightPort(port) {
    if (selectedPort === port) {
        selectedPort = null; // Toggle off
    } else {
        selectedPort = port; // Toggle on
    }
    
    // Update all port displays
    document.querySelectorAll('.port-display').forEach(el => {
        const portValue = parseInt(el.textContent);
        if (selectedPort === portValue) {
            el.classList.add('highlight-port');
        } else {
            el.classList.remove('highlight-port');
        }
    });
}

// Update statistics
function updateStatistics() {
    const serverCount = allServers.length;
    let brokerCount = 0;
    const uniquePorts = new Set();
    
    allServers.forEach(server => {
        brokerCount += server.brokers.length;
        server.brokers.forEach(broker => {
            const port = Object.values(broker)[0];
            uniquePorts.add(port);
        });
    });
    
    document.getElementById('serverCount').textContent = serverCount;
    document.getElementById('brokerCount').textContent = brokerCount;
    document.getElementById('portCount').textContent = uniquePorts.size;
    document.getElementById('avgBrokers').textContent = (brokerCount / serverCount).toFixed(1);
    
    document.getElementById('statsContainer').style.display = 'flex';
}

// Update port tags
function updatePortTags() {
    const portFrequency = {};
    
    // Count port frequencies
    allServers.forEach(server => {
        server.brokers.forEach(broker => {
            const port = Object.values(broker)[0];
            portFrequency[port] = (portFrequency[port] || 0) + 1;
        });
    });
    
    // Get top 10 most common ports
    const topPorts = Object.entries(portFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const portTagsContainer = document.getElementById('portTags');
    portTagsContainer.innerHTML = '';
    
    topPorts.forEach(([port, count]) => {
        const tag = document.createElement('span');
        tag.className = 'port-tag';
        tag.textContent = `${port} (${count})`;
        tag.onclick = () => {
            document.getElementById('portFilter').value = port;
            filterServers();
        };
        portTagsContainer.appendChild(tag);
    });
}

// Populate filters
function populateFilters() {
    const portFilter = document.getElementById('portFilter');
    
    // Get unique ports
    const uniquePorts = new Set();
    allServers.forEach(server => {
        server.brokers.forEach(broker => {
            const port = Object.values(broker)[0];
            uniquePorts.add(port);
        });
    });
    
    // Clear existing options (except first)
    while (portFilter.options.length > 1) {
        portFilter.remove(1);
    }
    
    // Add sorted port options
    Array.from(uniquePorts)
        .sort((a, b) => a - b)
        .forEach(port => {
            const option = document.createElement('option');
            option.value = port;
            option.textContent = `Port ${port}`;
            portFilter.appendChild(option);
        });
    
    // Add event listeners
    document.getElementById('searchInput').addEventListener('input', filterServers);
    portFilter.addEventListener('change', filterServers);
}

// Filter servers based on search criteria
function filterServers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const portFilterValue = document.getElementById('portFilter').value;
    
    const filteredServers = allServers.filter(server => {
        // Filter by port if specified
        if (portFilterValue) {
            const hasPort = server.brokers.some(broker => 
                Object.values(broker)[0] == portFilterValue
            );
            if (!hasPort) return false;
        }
        
        // Filter by search term
        if (searchTerm) {
            const searchInIP = server.ip.toLowerCase().includes(searchTerm);
            const searchInBrokers = server.brokers.some(broker => {
                const brokerName = Object.keys(broker)[0].toLowerCase();
                const port = Object.values(broker)[0].toString();
                return brokerName.includes(searchTerm) || port.includes(searchTerm);
            });
            
            return searchInIP || searchInBrokers;
        }
        
        return true;
    });
    
    displayServers(filteredServers);
}

// Clear all filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('portFilter').value = '';
    selectedPort = null;
    
    // Remove highlights
    document.querySelectorAll('.port-display').forEach(el => {
        el.classList.remove('highlight-port');
    });
    
    filterServers();
}

// Download as Excel
function downloadExcel() {
    // Prepare worksheet data
    const wsData = [
        ['Server IP', 'Broker Name', 'Port']
    ];
    
    allServers.forEach(server => {
        server.brokers.forEach(broker => {
            const brokerName = Object.keys(broker)[0];
            const port = Object.values(broker)[0];
            wsData.push([server.ip, brokerName, port]);
        });
    });
    
    // Create workbook
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Server Port Data");
    
    // Style columns
    const wscols = [
        {wch: 15}, // IP
        {wch: 30}, // Broker Name
        {wch: 8}   // Port
    ];
    ws['!cols'] = wscols;
    
    // Generate filename with timestamp
    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
    const filename = `server_ports_${timestamp}.xlsx`;
    
    // Download file
    XLSX.writeFile(wb, filename);
}

// UI Helper Functions
function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('statsContainer').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
}

function showMainContent() {
    document.getElementById('mainContent').style.display = 'block';
}

function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

// Initialize application
function initApp() {
    // Initial load
    loadData();
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
        loadData();
        const btn = document.getElementById('refreshBtn');
        btn.innerHTML = '<span class="btn-icon">‚è≥</span> Refreshing...';
        setTimeout(() => {
            btn.innerHTML = '<span class="btn-icon">üîÑ</span> Refresh';
        }, 1000);
    });
    
    // Download button
    document.getElementById('downloadBtn').addEventListener('click', downloadExcel);
    
    // Clear filters button
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl+F to focus search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            document.getElementById('searchInput').focus();
        }
        // Ctrl+D to download
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            downloadExcel();
        }
        // Escape to clear filters
        if (e.key === 'Escape') {
            clearFilters();
        }
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);

